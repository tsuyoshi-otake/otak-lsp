# 設計文書

## 概要

マークダウン文書フィルタリング機能は、日本語文法チェッカーがマークダウン文書を解析する際に、技術的要素（コードブロック、テーブル、URL等）を適切に除外し、誤検出を防ぐシステムです。現在の実装では、マークダウンファイル全体が解析対象となっているため、コードや設定値に対する不適切な文法警告が発生しています。

この機能により、技術文書作成者は以下の恩恵を受けられます：
- コードブロック内のプログラミングコードに対する誤った文法警告の回避
- マークダウンテーブル構造による長文警告や名詞連続警告の回避
- URL内テキストによる誤った警告の回避
- 設定キー名や技術用語に対する不適切な警告の回避

## アーキテクチャ

システムは以下の主要コンポーネントで構成されます：

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Grammar       │    │   Markdown       │    │   Filtered      │
│   Checker       │───▶│   Filter         │───▶│   Text          │
│                 │    │                  │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌──────────────────┐
                       │   Filter         │
                       │   Configuration  │
                       └──────────────────┘
```

### 処理フロー

1. **入力受信**: Grammar Checkerがマークダウン文書を受信
2. **フィルタリング実行**: Markdown Filterが設定に基づいてテキストをフィルタリング
3. **除外範囲特定**: コードブロック、テーブル、URL等の除外範囲を特定
4. **フィルタリング適用**: 除外範囲を文法チェック対象から除外
5. **結果返却**: フィルタリング済みテキストと除外範囲情報を返却

## コンポーネントと インターフェース

### MarkdownFilter

マークダウン構造を解析し、除外すべきテキスト範囲を特定するコアコンポーネント。

```typescript
interface MarkdownFilter {
  filter(text: string, config: FilterConfig): FilterResult;
  getExcludedRanges(text: string, config: FilterConfig): ExcludedRange[];
}
```

### FilterConfig

フィルタリング動作を制御する設定インターフェース。

```typescript
interface FilterConfig {
  excludeCodeBlocks: boolean;
  excludeInlineCode: boolean;
  excludeTables: boolean;
  excludeUrls: boolean;
  excludeConfigKeys: boolean;
  customExcludePatterns: RegExp[];
  debugMode: boolean;
}
```

### FilterResult

フィルタリング処理の結果を表すインターフェース。

```typescript
interface FilterResult {
  filteredText: string;
  excludedRanges: ExcludedRange[];
  originalText: string;
  debugInfo?: DebugInfo;
}
```

### ExcludedRange

除外されたテキスト範囲の情報を表すインターフェース。

```typescript
interface ExcludedRange {
  start: number;
  end: number;
  type: 'code-block' | 'inline-code' | 'table' | 'url' | 'config-key' | 'custom';
  content: string;
  reason: string;
}
```

## データモデル

### マークダウン要素の分類

1. **コードブロック**: ```で囲まれた複数行コード
2. **インラインコード**: `で囲まれた単一行コード
3. **テーブル**: |で区切られたマークダウンテーブル
4. **URL**: http(s)://で始まるURL、マークダウンリンク記法
5. **設定キー**: otakLcp.*のような設定キー名
6. **カスタムパターン**: ユーザー定義の除外パターン

### 除外優先度

1. コードブロック（最高優先度）
2. インラインコード
3. URL
4. 設定キー
5. カスタムパターン
6. テーブル構造（最低優先度）

## 正確性プロパティ

*プロパティとは、システムの全ての有効な実行において真であるべき特性や動作のことです。プロパティは、人間が読める仕様と機械で検証可能な正確性保証の橋渡しとなります。*

### プロパティ反映

プリワーク分析を基に、以下の冗長性を特定し統合しました：

- **コードブロック関連**: プロパティ1.1、1.2、1.3を統合 → Property 1
- **テーブル関連**: プロパティ2.1、2.2、2.3、2.4を統合 → Property 2  
- **URL関連**: プロパティ3.1、3.2、3.3、3.4を統合 → Property 3
- **設定関連**: プロパティ4.1、4.2、4.3、4.4を統合 → Property 4
- **検証関連**: プロパティ5.1、5.2、5.3、5.4を統合 → Property 5

### Property 1: コードブロック除外の完全性
*任意の* マークダウンテキストにおいて、コードブロック（```で囲まれた部分）およびインラインコード（`で囲まれた部分）を含む場合、フィルタリング後のテキストにはコード内容が含まれていない
**Validates: Requirements 1.1, 1.2, 1.3**

### Property 2: テーブル構造の適切な処理
*任意の* マークダウンテーブルにおいて、各テーブルセルが独立した文として扱われ、テーブル区切り文字（|）が読点としてカウントされず、設定キー名が除外される
**Validates: Requirements 2.1, 2.2, 2.3, 2.4**

### Property 3: URL除外の包括性
*任意の* テキストにおいて、URL（プレーンテキスト、マークダウンリンク記法、自動リンク記法）が含まれる場合、URL部分が文法チェック対象から除外される（マークダウンリンクのテキスト部分は除く）
**Validates: Requirements 3.1, 3.2, 3.3, 3.4**

### Property 4: 設定変更の一貫性
*任意の* フィルタリング設定において、設定変更がフィルタリング動作に正しく反映され、無効設定時はデフォルト動作となる
**Validates: Requirements 4.1, 4.2, 4.3, 4.4**

### Property 5: フィルタリング結果の検証可能性
*任意の* フィルタリング処理において、除外範囲情報が提供され、デバッグモード時は詳細ログが出力され、エラー時は詳細情報が報告される
**Validates: Requirements 5.1, 5.2, 5.3, 5.4**

## エラーハンドリング

### エラー分類

1. **構文エラー**: 不正なマークダウン構文
2. **設定エラー**: 無効なフィルタリング設定
3. **処理エラー**: フィルタリング処理中の例外
4. **パフォーマンスエラー**: 大容量ファイル処理時のタイムアウト

### エラー処理戦略

- **Graceful Degradation**: エラー発生時はフィルタリングを無効化し、元のテキストを返却
- **詳細ログ**: デバッグモード時はエラー詳細とスタックトレースを記録
- **ユーザー通知**: 重要なエラーはユーザーに分かりやすいメッセージで通知
- **自動復旧**: 一時的なエラーは自動的にリトライ

## テスト戦略

### デュアルテストアプローチ

本機能では、ユニットテストとプロパティベーステストの両方を実装します：

- **ユニットテスト**: 具体的な例、エッジケース、エラー条件を検証
- **プロパティベーステスト**: 全入力に対して成り立つべき普遍的プロパティを検証

両者は補完的であり、ユニットテストは具体的なバグを捉え、プロパティテストは一般的な正確性を検証します。

### ユニットテスト

ユニットテストは以下をカバーします：
- 特定のマークダウン構文パターンの正確な処理
- エラー条件と境界値の処理
- コンポーネント間の統合ポイント

### プロパティベーステスト

- **使用ライブラリ**: fast-check
- **実行回数**: 各プロパティテストは最低30回実行
- **タグ付け**: 各プロパティベーステストは対応する正確性プロパティを明示的に参照
- **タグ形式**: '**Feature: markdown-document-filtering, Property {number}: {property_text}**'

各正確性プロパティは単一のプロパティベーステストで実装され、設計文書のプロパティと1対1で対応します。