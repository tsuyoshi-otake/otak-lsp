# 実装計画

- [x] 1. 根本原因調査と設計方針の確定
  - 現在の実装で「白色のまま」になるパターンを特定
  - MarkdownFilterのスペース置換方式とPositionMapperの位置計算の整合性を確認
  - セマンティックトークン生成時にPositionMapperが使用されていない理由を調査
  - スペース置換方式での正しい実装方針を決定
  - **結果**: MarkdownFilterはスペース置換を使用（位置保持）。除外範囲内のトークンをフィルタリングする必要あり。
  - _要件: 1.1, 1.2, 1.3, 2.1, 2.2, 2.3_

- [x] 1.1 PositionMapperの実装方針を決定
  - スペース置換方式に合わせた実装に修正するか、設計を変更するか決定
  - **結果**: セマンティックトークンにはPositionMapper不要（スペース置換により位置が保持される）。PositionMapperは診断用に引き続き使用。
  - positionMapper.test.tsの期待値を現在の方式に合わせて修正
  - _要件: 3.1, 3.2, 3.3_

- [x] 2. TokenFilterクラスの実装
  - server/src/semantic/tokenFilter.tsファイルを作成
  - filterTokensメソッドを実装：除外範囲内のトークンをフィルタリング
  - isTokenInExcludedRangeメソッドを実装：トークンが除外範囲内にあるかチェック
  - トークンが除外範囲と部分的に重複する場合の判定ロジックを明確化
  - _要件: 2.1, 2.2, 2.3_

- [x] 2.1 TokenFilterのプロパティベーステストを実装
  - **プロパティ 1: トークンフィルタリングの完全性**
  - **検証: 要件 2.1, 2.2, 2.3**
  - ランダムなトークンリストと除外範囲リストを生成
  - フィルタリング後のすべてのトークンが除外範囲外にあることを確認
  - _要件: 2.1, 2.2, 2.3_

- [x] 2.2 TokenFilterのユニットテストを実装
  - filterTokensメソッドのテスト：除外範囲内のトークンが正しく除外されることを確認
  - isTokenInExcludedRangeメソッドのテスト：トークンが除外範囲内にある場合にtrueを返すことを確認
  - 空のトークンリストを処理できることを確認
  - エッジケース：改行コード差異(\r\n vs \n)、空ドキュメント、境界条件
  - _要件: 2.1, 2.2, 2.3_

- [x] 3. SemanticTokenProviderの修正
  - provideSemanticTokensメソッドのシグネチャを確認
  - スペース置換方式の場合、トークンの位置情報はそのまま使用可能
  - 位置情報の計算ロジックを確認：トークンの位置情報がフィルタリング後のテキスト基準であることを前提とする
  - **結果**: 既存実装で正しく動作。修正不要。
  - _要件: 1.2, 1.3_

- [x] 3.1 SemanticTokenProviderのプロパティベーステストを実装
  - **プロパティ 2: セマンティックトークンの位置正確性**
  - **検証: 要件 1.2, 1.3**
  - ランダムなトークンリストとテキストを生成
  - 各セマンティックトークンの位置が元のテキスト内の対応する位置と一致することを確認
  - _要件: 1.2, 1.3_

- [x] 3.2 SemanticTokenProviderのプロパティベーステストを実装
  - **プロパティ 3: セマンティックトークンの完全性**
  - **検証: 要件 1.1, 1.4**
  - ランダムなトークンリストを生成
  - すべてのトークンに対応するセマンティックトークンが生成されることを確認
  - _要件: 1.1, 1.4_

- [x] 4. main.tsの修正
  - TokenFilterのインスタンスを作成
  - analyzeDocument関数を修正：TokenFilterを使用してトークンをフィルタリング
  - documentTextsに保存するテキストを決定（元のテキスト vs フィルタリング後のテキスト）
  - セマンティックトークン生成時の渡し方を明確化
  - documentTokensキャッシュにフィルタリング後のトークンを保存
  - デバッグログ出力機能を追加（問題調査用）
  - _要件: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3_

- [x] 4.1 HoverProviderへの影響確認
  - Markdownファイルでホバー機能が正しく動作するか確認
  - **結果**: 既存テストで動作確認済み。
  - 必要に応じて位置マッピングを追加
  - _要件: 関連機能の整合性_

- [x] 5. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、質問があればユーザーに尋ねる
  - **結果**: 994テスト通過

- [x] 6. Position Mapperのプロパティベーステストを実装
  - **プロパティ 4: Position Mapperの正確性**
  - **検証: 要件 3.1, 3.2, 3.3**
  - ランダムなテキストと除外範囲を生成
  - スペース置換方式に合わせた期待値でテスト
  - マッピングが正しく行われることを確認
  - 除外範囲内のオフセットに対してnullが返されることを確認
  - 既存のpositionMapper.test.tsとの整合性を確認・更新
  - _要件: 3.1, 3.2, 3.3_

- [x] 7. 統合テストの実装
  - 実際のMarkdownファイルを解析するテストを作成
  - すべての日本語テキストが色付けされることを確認
  - コードブロック、テーブル、URL内のテキストが色付けされないことを確認
  - _要件: 1.1, 1.4, 2.1, 2.2, 2.3_

- [x] 8. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、質問があればユーザーに尋ねる
  - **結果**: 1078テスト通過（75テストスイート）
  - README.mdなどの実際のMarkdownファイルで動作確認
  - **解決**: README.mdで白色のまま残っていた語は、品詞`助動詞`/`連体詞`/`接続詞`/`接頭詞`（＋一般文書で出現しうる`感動詞`/`フィラー`）が`other`扱いになっていたことが原因。`SemanticTokenProvider`でこれらを既存の色付きカテゴリへマッピングすることで、除外対象以外の日本語が一貫して色付くことを確認。
