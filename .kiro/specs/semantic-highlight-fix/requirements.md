# 要件ドキュメント

## はじめに

otak-lcpは日本語形態素解析VSCode拡張機能で、セマンティックハイライト機能を提供しています。現在、Markdownファイルにおいてセマンティックハイライトが不完全で、多くの単語が白色のまま表示されています。これは、Markdownフィルタリング後のテキストに対してトークン化を行っているものの、セマンティックトークンの位置情報が元のドキュメントに正しくマッピングされていないことが原因です。

## 用語集

- **System**: otak-lcp Language Server
- **Semantic Token**: 品詞情報に基づいて色分けされるトークン
- **Position Mapper**: フィルタリングされたテキストの位置を元のドキュメントの位置にマッピングするコンポーネント
- **Markdown Filter**: Markdownドキュメントからコードブロック、テーブル、URLなどを除外するコンポーネント
- **Token Provider**: セマンティックトークン情報を生成するコンポーネント

## 要件

### 要件 1

**ユーザーストーリー:** 開発者として、Markdownファイル内の日本語テキストがすべて品詞に応じて色分けされることを期待します。これにより、文書の可読性が向上します。

#### 受入基準

1. WHEN System がMarkdownドキュメントを解析するとき、THEN System はフィルタリング後のテキスト内のすべての日本語トークンに対してセマンティックトークンを生成しなければならない
2. WHEN System がセマンティックトークンを生成するとき、THEN System は各トークンの位置を元のドキュメントの位置に正しくマッピングしなければならない
3. WHEN System がセマンティックトークンをクライアントに送信するとき、THEN System はマッピングされた位置情報を使用しなければならない
4. WHEN ユーザーがMarkdownファイルを開くとき、THEN System はフィルタリング対象外のすべての日本語テキストに色付けを適用しなければならない

### 要件 2

**ユーザーストーリー:** 開発者として、コードブロックやテーブル内のテキストはセマンティックハイライトの対象外であることを期待します。これにより、コードとドキュメントの区別が明確になります。

#### 受入基準

1. WHEN System がMarkdownドキュメントを解析するとき、THEN System はコードブロック内のテキストをセマンティックハイライトの対象から除外しなければならない
2. WHEN System がMarkdownドキュメントを解析するとき、THEN System はテーブル内のテキストをセマンティックハイライトの対象から除外しなければならない
3. WHEN System がMarkdownドキュメントを解析するとき、THEN System はURL内のテキストをセマンティックハイライトの対象から除外しなければならない

### 要件 3

**ユーザーストーリー:** 開発者として、Position Mapperが正確に動作することを期待します。これにより、フィルタリングされたテキストと元のドキュメント間の位置変換が正しく行われます。

#### 受入基準

1. WHEN Position Mapper がフィルタリングされたテキストのオフセットを受け取るとき、THEN Position Mapper は対応する元のドキュメントのオフセットを返さなければならない
2. WHEN Position Mapper が除外範囲内のオフセットを受け取るとき、THEN Position Mapper はnullを返さなければならない
3. WHEN Position Mapper が範囲をマッピングするとき、THEN Position Mapper は開始位置と終了位置の両方を正しくマッピングしなければならない
