# 要件ドキュメント

## はじめに

otak-lcp拡張機能において、README.mdなどのMarkdownファイルを開いた際に、全行に単一の波線（診断）が表示される問題が発生しています。この問題は、診断の範囲（range）計算に不具合があることが原因です。本機能では、診断の範囲計算ロジックを修正し、正しい位置に波線が表示されるようにします。

## 用語集

- **診断（Diagnostic）**: LSPプロトコルで定義される、コードの問題を示す情報。範囲、メッセージ、重要度などを含む
- **範囲（Range）**: 診断が適用されるテキストの開始位置と終了位置
- **位置（Position）**: 行番号（line）と文字位置（character）で表される、テキスト内の特定の場所
- **オフセット（Offset）**: テキストの先頭からの文字数で表される位置
- **AdvancedRulesManager**: 高度な文法ルールを管理し、診断を生成するクラス
- **PositionMapper**: Markdownフィルタリング後のテキスト位置を元のテキスト位置にマッピングするクラス

## 要件

### 要件 1

**ユーザーストーリー:** 開発者として、Markdownファイルを開いたときに、文法エラーが正しい位置に表示されることを期待します。これにより、エラーの原因を素早く特定できます。

#### 受入基準

1. WHEN AdvancedRulesManagerが診断を生成する THEN システムは各診断の範囲を正しい行と文字位置で計算する
2. WHEN 診断の範囲が既に正しい行/文字ベースの位置を持っている THEN システムは範囲を変更しない
3. WHEN 診断の範囲がオフセットベースである THEN システムは範囲を行/文字ベースに変換する
4. WHEN Markdownファイルに複数の文法エラーがある THEN システムは各エラーを個別の範囲で表示する
5. WHEN 診断の範囲計算が失敗する THEN システムはエラーをログに記録し、診断をスキップする

### 要件 2

**ユーザーストーリー:** 開発者として、診断の範囲計算ロジックが明確で保守しやすいことを期待します。これにより、将来の変更が容易になります。

#### 受入基準

1. WHEN 範囲計算ロジックを実装する THEN システムは範囲がオフセットベースか行/文字ベースかを明確に判定する
2. WHEN 範囲変換を行う THEN システムは変換前後の値をデバッグログに記録する
3. WHEN 範囲計算に使用する行開始位置配列を構築する THEN システムは改行文字を正しく処理する
4. WHEN offsetToPositionメソッドを呼び出す THEN システムは境界値を適切に処理する

### 要件 3

**ユーザーストーリー:** 開発者として、診断の範囲計算が正しく動作することを自動テストで検証できることを期待します。これにより、リグレッションを防ぎます。

#### 受入基準

1. WHEN 範囲計算ロジックをテストする THEN システムは様々な入力パターンで正しい結果を返す
2. WHEN オフセットベースの範囲を変換する THEN システムは正しい行/文字位置を返す
3. WHEN 既に正しい範囲を持つ診断を処理する THEN システムは範囲を変更しない
4. WHEN 無効な範囲を持つ診断を処理する THEN システムはエラーを適切に処理する
