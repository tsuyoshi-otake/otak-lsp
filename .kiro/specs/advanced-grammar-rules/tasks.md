# 実装計画

## 既存の実装について

既存のシステムには以下が実装済みです：
- `GrammarChecker`クラス（`server/src/grammar/checker.ts`）
- `GrammarRule`インターフェース
- 基本的な文法ルール（二重助詞、助詞連続、動詞-助詞不整合、冗長な助動詞）
- `Token`、`GrammarError`、`Diagnostic`などのコア型定義（`shared/src/types.ts`）

新しい高度な文法ルールは、既存の`GrammarRule`インターフェースを実装する形で追加します。

## タスク

- [x] 1. 高度な文法ルール用の型定義の追加
  - `GrammarErrorType`に新しいエラータイプを追加（`shared/src/types.ts`）
  - Sentence、StyleInconsistency等の新しいデータモデルを追加
  - 高度なルール用の設定型を定義
  - _要件: 1.1, 2.1, 3.1, 4.1, 5.1, 6.1, 7.1, 8.1, 9.1, 10.1, 11.1_

- [x] 2. 文解析ユーティリティの実装
  - テキストを文に分割する機能を実装（`server/src/grammar/sentenceParser.ts`）
  - 句点による文の区切りを認識
  - 各文のトークンリストを生成
  - 読点のカウント機能を実装
  - _要件: 1.1, 9.4_

- [x] 2.1 ユニットテスト: 文解析ユーティリティ
  - 文の分割を検証
  - 読点のカウントを検証
  - エッジケース（空文字列、句点のみ）を検証
  - _要件: 1.1, 9.4_

- [x] 3. Style Consistency Ruleの実装
  - `StyleConsistencyRule`クラスを作成（`server/src/grammar/rules/styleConsistencyRule.ts`）
  - `GrammarRule`インターフェースを実装
  - 文末パターンによる文体認識を実装（「です」「ます」→敬体、「である」→常体）
  - 「だ」などその他の文末は中立として扱う
  - 文書内の文体混在を検出
  - 診断情報と文体統一の提案を生成
  - 既存の`GrammarChecker`に登録
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 3.1 プロパティテスト: 文体認識の正確性
  - **プロパティ 1: 文体認識の正確性**
  - **検証: 要件 1.1, 1.2, 1.5**

- [x] 3.2 プロパティテスト: 文体混在の検出
  - **プロパティ 2: 文体混在の検出**
  - **検証: 要件 1.3, 1.4**

- [x] 3.3 ユニットテスト: Style Consistency Rule
  - 「です」「ます」の敬体認識を検証
  - 「である」の常体認識を検証
  - 「だ」が中立として扱われることを検証
  - 文体混在の検出を検証
  - _要件: 1.1, 1.2, 1.3, 1.5_

- [x] 4. Ra-nuki Detection Ruleの実装
  - `RaNukiRule`クラスを作成（`server/src/grammar/rules/raNukiRule.ts`）
  - `GrammarRule`インターフェースを実装
  - 動詞の活用タイプ判定を実装（五段活用、一段活用）
  - 「れる」接続のら抜き言葉を検出
  - 正しい「られる」形への修正候補を生成
  - 診断情報を生成
  - 既存の`GrammarChecker`に登録
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 5.1 プロパティテスト: ら抜き言葉の検出と提案
  - **プロパティ 3: ら抜き言葉の検出と提案**
  - **検証: 要件 2.1, 2.2, 2.3, 2.4, 2.5**

- [x] 5.2 ユニットテスト: Ra-nuki Detection Rule
  - 「食べれる」→「食べられる」の検出を検証
  - 「見れる」→「見られる」の検出を検証
  - 正しい「られる」形でエラーが出ないことを検証
  - _要件: 2.1, 2.2, 2.5_

- [x] 6. Double Negation Ruleの実装
  - 二重否定パターンを定義（「ないわけではない」「ないことはない」など）
  - 二重否定を検出
  - 肯定表現への書き換え提案を生成
  - 診断情報を生成
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 6.1 プロパティテスト: 二重否定の検出と提案
  - **プロパティ 4: 二重否定の検出と提案**
  - **検証: 要件 3.1, 3.2, 3.3, 3.5**

- [x] 6.2 ユニットテスト: Double Negation Rule
  - 「ないわけではない」の検出を検証
  - 「ないことはない」の検出を検証
  - 単一否定でエラーが出ないことを検証
  - _要件: 3.4, 3.5_

- [x] 7. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [x] 8. Particle Repetition Ruleの実装
  - 同じ助詞の連続使用を検出
  - 設定による有効/無効の制御を実装
  - 文の書き換え提案を生成
  - 診断情報を生成
  - _要件: 4.1, 4.3, 4.4, 4.5_

- [x] 8.1 プロパティテスト: 助詞連続使用の設定依存検出
  - **プロパティ 5: 助詞連続使用の設定依存検出**
  - **検証: 要件 4.1, 4.3, 4.4**

- [x] 8.2 ユニットテスト: Particle Repetition Rule
  - 同じ助詞の連続使用検出を検証
  - 設定による無効化を検証
  - デフォルト設定で無効であることを検証
  - _要件: 4.1, 4.3, 4.5_

- [x] 9. Conjunction Repetition Ruleの実装
  - 一般的な接続詞リストを定義（「しかし」「また」「そして」など）
  - 同じ接続詞の連続使用を検出
  - 代替の接続詞を提案
  - 1文おきの使用は検出しない
  - 診断情報を生成
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 9.1 プロパティテスト: 接続詞連続使用の検出と代替案
  - **プロパティ 6: 接続詞連続使用の検出と代替案**
  - **検証: 要件 5.1, 5.2, 5.4, 5.5**

- [x] 9.2 ユニットテスト: Conjunction Repetition Rule
  - 「しかし」の連続使用検出を検証
  - 代替接続詞の提案を検証
  - 1文おきの使用で検出されないことを検証
  - _要件: 5.3, 5.5_

- [x] 10. Adversative Ga Ruleの実装
  - 逆接の「が」と格助詞の「が」を区別
  - 逆接の「が」の連続使用を検出
  - 文の分割や接続詞の変更を提案
  - 1文おきの使用は検出しない
  - 診断情報を生成
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 10.1 プロパティテスト: 逆接「が」の連続使用検出
  - **プロパティ 7: 逆接「が」の連続使用検出**
  - **検証: 要件 6.1, 6.2, 6.3, 6.4, 6.5**

- [x] 10.2 ユニットテスト: Adversative Ga Rule
  - 逆接の「が」の検出を検証
  - 格助詞の「が」が検出されないことを検証
  - 1文おきの使用で検出されないことを検証
  - _要件: 6.3, 6.4_

- [x] 11. Alphabet Width Ruleの実装
  - 全角アルファベットと半角アルファベットを検出
  - 文書内の混在を検出
  - 半角への変換提案を生成
  - 統一されている場合は検出しない
  - 診断情報を生成
  - _要件: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 11.1 プロパティテスト: 全角半角混在の検出と提案
  - **プロパティ 8: 全角半角混在の検出と提案**
  - **検証: 要件 7.1, 7.2, 7.3, 7.4, 7.5**

- [x] 11.2 ユニットテスト: Alphabet Width Rule
  - 全角と半角の混在検出を検証
  - 半角のみで検出されないことを検証
  - 全角のみで検出されないことを検証
  - _要件: 7.3, 7.4_

- [x] 12. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [x] 13. Weak Expression Ruleの実装
  - 弱い表現パターンを定義（「かもしれない」「と思われる」「ような気がする」など）
  - 弱い表現を検出
  - より断定的な表現を提案
  - 診断情報を生成
  - _要件: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 13.1 プロパティテスト: 弱い表現の検出と強化提案
  - **プロパティ 9: 弱い表現の検出と強化提案**
  - **検証: 要件 8.4, 8.5**

- [x] 13.2 ユニットテスト: Weak Expression Rule
  - 「かもしれない」の検出を検証
  - 「と思われる」の検出を検証
  - 「ような気がする」の検出を検証
  - 断定的な表現の提案を検証
  - _要件: 8.1, 8.2, 8.3_

- [x] 14. Comma Count Ruleの実装
  - 1文中の読点をカウント
  - 閾値（デフォルト4個）を超える場合に検出
  - 文の分割を提案
  - 診断情報に読点の数を含める
  - _要件: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 14.1 プロパティテスト: 読点数の閾値チェック
  - **プロパティ 10: 読点数の閾値チェック**
  - **検証: 要件 9.1, 9.2, 9.3, 9.4, 9.5**

- [x] 14.2 ユニットテスト: Comma Count Rule
  - 5個以上の読点の検出を検証
  - 4個以下で検出されないことを検証
  - 診断情報に読点の数が含まれることを検証
  - _要件: 9.1, 9.3, 9.5_

- [x] 15. Term Notation Ruleの実装
  - `TermNotationRule`クラスを作成（`server/src/grammar/rules/termNotationRule.ts`）
  - `GrammarRule`インターフェースを実装
  - 基本的なウェブ技術用語の表記ルールを定義（Javascript→JavaScript、Github→GitHub等）
  - 生成AI関連用語の表記ルールを定義（chatgpt→ChatGPT、openai→OpenAI等）
  - AWS関連用語の表記ルールを定義（aws→AWS、ec2→EC2、s3→S3等）
  - Azure関連用語の表記ルールを定義（azure→Azure、cosmos db→Cosmos DB等）
  - OCI関連用語の表記ルールを定義（oci→OCI、oracle cloud→Oracle Cloud等）
  - 設定に基づいて有効な辞書を選択する機能を実装
  - 誤った表記を検出
  - 正しい表記への修正を提案
  - カスタムルールの追加機能を実装
  - 診断情報を生成
  - 既存の`GrammarChecker`に登録
  - _要件: 10.1, 10.2, 10.3, 10.4, 10.5, 12.1, 12.2, 12.3, 12.4, 12.5, 13.4_

- [x] 15.1 プロパティテスト: 技術用語表記の統一
  - **プロパティ 11: 技術用語表記の統一**
  - **検証: 要件 10.5, 12.1, 12.2, 12.3, 12.4, 12.5**

- [x] 15.2 ユニットテスト: Term Notation Rule
  - ウェブ技術用語の検出を検証（「Javascript」→「JavaScript」等）
  - 生成AI用語の検出を検証（「chatgpt」→「ChatGPT」、「openai」→「OpenAI」等）
  - AWS用語の検出を検証（「aws」→「AWS」、「lambda」→「Lambda」等）
  - Azure用語の検出を検証（「azure」→「Azure」、「cosmos db」→「Cosmos DB」等）
  - OCI用語の検出を検証（「oci」→「OCI」等）
  - 辞書の有効/無効設定を検証
  - カスタムルールの追加を検証
  - _要件: 10.1, 10.2, 10.3, 10.4, 12.1, 12.2, 12.3, 12.4, 13.4_

- [x] 16. Kanji Opening Ruleの実装
  - 漢字開きルールを定義（下さい→ください、出来る→できる等）
  - 開くべき漢字を検出
  - ひらがな表記への修正を提案
  - 診断情報を生成
  - _要件: 11.1, 11.2, 11.3, 11.4, 11.5_

- [x] 16.1 プロパティテスト: 漢字開きの統一
  - **プロパティ 12: 漢字開きの統一**
  - **検証: 要件 11.5**

- [x] 16.2 ユニットテスト: Kanji Opening Rule
  - 「下さい」→「ください」の検出を検証
  - 「出来る」→「できる」の検出を検証
  - 「有難う」→「ありがとう」の検出を検証
  - 「宜しく」→「よろしく」の検出を検証
  - _要件: 11.1, 11.2, 11.3, 11.4_

- [x] 17. Advanced Rules Configの実装
  - 設定インターフェースを定義（`shared/src/types.ts`に追加）
  - デフォルト設定値を定義（助詞連続チェックは初期無効）
  - 各ルールの有効/無効設定を実装
  - 技術用語辞典の有効/無効設定を実装（ウェブ技術、生成AI、AWS、Azure、OCI）
  - Untitledファイルと拡張子なしファイルの処理設定を実装
  - 読点の閾値設定を実装
  - 弱い表現の検出レベル設定を実装
  - カスタム表記統一ルールの設定を実装
  - _要件: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 17.1 Document Filterの実装
  - `JapaneseDocumentFilter`クラスを作成（`server/src/grammar/documentFilter.ts`）
  - 言語IDベースの判定を実装
  - 内容ベースの日本語検出を実装（正規表現）
  - 除外リストの処理を実装
  - Untitledファイルの判定を実装
  - 日本語判定の最適化（最初の1000文字で判定、その後は全文を解析）
  - _要件: 13.1, 13.2, 13.3, 13.4, 13.5_

- [x] 17.2 プロパティテスト: Untitledファイルと拡張子なしファイルの処理
  - **プロパティ 13: Untitledファイルと拡張子なしファイルの処理**
  - **検証: 要件 13.1, 13.2, 13.3, 13.4, 13.5**

- [x] 17.3 ユニットテスト: Document Filter
  - Untitledファイルの判定を検証
  - 内容ベースの日本語検出を検証
  - 除外リストの動作を検証
  - 日本語判定の最適化（1000文字での判定）を検証
  - _要件: 13.1, 13.2, 13.3, 13.4_

- [x] 17.4 プロパティテスト: 設定変更の即時反映
  - **プロパティ 14: 設定変更の即時反映**
  - **検証: 要件 14.5**

- [x] 17.5 ユニットテスト: Advanced Rules Config
  - デフォルト設定値を検証
  - 助詞連続チェックが初期無効であることを検証
  - 技術用語辞典がすべて初期有効であることを検証
  - Untitledファイル処理が初期有効であることを検証
  - 設定の読み書きを検証
  - _要件: 4.5, 13.1, 14.1, 14.2, 14.3_

- [x] 18. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [x] 19. 既存Grammar Checkerとの統合
  - Advanced Rules Managerを既存のGrammar Checkerに統合
  - 基本ルールと高度なルールの診断情報をマージ
  - 設定による高度なルールの有効/無効を実装
  - _要件: 1.1, 2.1, 3.1, 4.1, 5.1, 6.1, 7.1, 8.1, 9.1, 10.1, 11.1_

- [x] 19.1 統合テスト: Grammar Checkerとの統合
  - 基本ルールと高度なルールが両方実行されることを検証
  - 診断情報のマージを検証
  - 設定による制御を検証
  - _要件: 12.5_

- [x] 20. VSCode設定項目の追加
  - package.jsonに高度な文法ルールの設定項目を追加
  - 各ルールの有効/無効設定を追加
  - 技術用語辞典の有効/無効設定を追加（ウェブ技術、生成AI、AWS、Azure、OCI）
  - Untitledファイルと拡張子なしファイルの処理設定を追加
  - 内容ベースの日本語検出設定を追加
  - 除外する言語IDのリスト設定を追加
  - 読点の閾値設定を追加
  - 弱い表現の検出レベル設定を追加
  - カスタム表記統一ルールの設定を追加
  - _要件: 13.5, 14.1, 14.2, 14.3, 14.4_

- [x] 21. READMEの更新
  - 高度な文法ルールの機能説明を追加
  - 各ルールの説明と例を記述
  - 技術用語辞典の説明を追加（生成AI、AWS、Azure、OCI）
  - サポートされている技術用語のリストを記述
  - Untitledファイルと拡張子なしファイルのサポートを説明
  - 内容ベースの日本語検出機能を説明
  - 設定項目の説明を追加
  - 使用例とスクリーンショットを追加
  - _要件: 1.1, 2.1, 3.1, 4.1, 5.1, 6.1, 7.1, 8.1, 9.1, 10.1, 11.1, 12.1, 12.2, 12.3, 12.4, 12.5, 13.1, 14.1_

- [x] 22. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

## Evalsテストスイート（NG例全量リスト対応）

- [x] 23. NG例データファイルの作成
  - `server/src/grammar/evals/ng-examples-data.ts` を作成
  - 全31カテゴリのNG例を構造化データとして定義
  - 各カテゴリに: id, name, examples[], expectedRule (実装済み/未実装)
  - 2025-12-10時点の全NG例を含める

- [x] 24. Evals実行エンジンの作成
  - `server/src/grammar/evals/evals-runner.ts` を作成
  - NG例データを読み込み、GrammarCheckerで解析
  - 各例文に対して検出結果を記録
  - 検出成功/失敗/未実装を判定

- [x] 25. Evalsレポート生成機能
  - `server/src/grammar/evals/evals-reporter.ts` を作成
  - Markdown形式の評価レポートを生成
  - カテゴリ別の検出率（検出数/全例数）
  - 実装済み vs 未実装の一覧
  - 全体カバレッジ率
  - 検出失敗した例文の詳細リスト

- [x] 26. Evalsコマンドの作成
  - `npm run evals` コマンドを追加
  - 実行すると `evals-report.md` を出力
  - コンソールにサマリーを表示:
    ```
    === Japanese Grammar Evals Report ===
    Total Categories: 31
    Implemented: 9 (29%)
    Detected: 27/31 examples (87%)
    Not Detected: 4 examples
    ```

- [x] 27. Evalsテスト統合
  - `server/src/grammar/evals/ng-examples.eval.test.ts` を作成
  - Jest テストとしてEvalsを実行
  - 検出率が閾値を下回ったら失敗
  - CI/CDで自動実行可能

- [x] 28. README.md評価結果埋め込み機能
  - README.mdに `<!-- EVALS-START -->` と `<!-- EVALS-END -->` マーカーを追加
  - `npm run evals:update-readme` コマンドを作成
  - マーカー間に最新の評価結果テーブルを自動挿入
  - 埋め込む内容:
    - 検出カバレッジ率のバッジ
    - カテゴリ別検出状況テーブル（PASS/FAIL/NOT_IMPL）
    - 最終評価日時
  - 例:
    ```markdown
    ## Detection Coverage

    ![Coverage](https://img.shields.io/badge/coverage-87%25-green)

    | Category | Status | Example |
    |----------|--------|---------|
    | Style Consistency | PASS | これは素敵です。あれは平凡である。 |
    | Ra-nuki | PASS | 食べれる |
    | Redundant Expression | NOT_IMPL | 馬から落馬する |

    Last updated: 2025-12-11
    ```

## 既存ルールの改善（Evals検出漏れ対応）

### 助詞連続ルールの改善

- [x] 29. 助詞連続ルールの検出精度向上
  - `ParticleSequenceRule`を改善（`server/src/grammar/checker.ts`）
  - 副詞トークンの末尾助詞と次の助詞の連続も検出するように拡張
  - 検出漏れ例: `本にを置く`（「本に」が副詞として解析される問題に対応）
  - `checkAdverbParticleSequence`メソッドを追加
  - 既存のテストを更新
  - 新しいテストケースを追加

- [x] 29.1 ユニットテスト: 助詞連続ルールの改善
  - 「本にを置く」の検出を検証
  - 「机にを置く」の検出を検証
  - 既存の検出パターンが壊れていないことを確認

### 冗長な助動詞ルールの改善

- [x] 30. 冗長な助動詞ルールの検出精度向上
  - `RedundantCopulaRule`を改善（`server/src/grammar/checker.ts`）
  - 助動詞「で」+助動詞「です/ます」のパターンを検出
  - 検出漏れ例: `問題でです`、`原因でます`（「で」が助動詞として解析される問題に対応）
  - `PROBLEMATIC_PATTERNS`に助動詞+助動詞のパターンを追加
  - 既存のテストを更新
  - 新しいテストケースを追加

- [x] 30.1 ユニットテスト: 冗長な助動詞ルールの改善
  - 「問題でです」の検出を検証
  - 「原因でます」の検出を検証
  - 「理由でます」の検出を検証
  - 既存の検出パターンが壊れていないことを確認

### 文体混在ルールの改善

- [x] 31. 文体混在ルールの検出精度向上
  - `StyleConsistencyRule`を改善（`server/src/grammar/rules/styleConsistencyRule.ts`）
  - 複文での文体混在を検出
  - 検出漏れ例: `システムは正常に動作します。しかし、問題が残っている。`
  - 文末が「〜ている」「〜てある」「〜た」「〜だ」の場合も常体として認識
  - 既存のテストを更新
  - 新しいテストケースを追加

- [x] 31.1 プロパティテスト: 文体混在ルールの改善
  - **プロパティ 2: 文体混在の検出**（更新）
  - 複文での文体混在を検証
  - **検証: 要件 1.3, 1.4**

- [x] 31.2 ユニットテスト: 文体混在ルールの改善
  - 「動作します。問題が残っている。」の検出を検証
  - 「実行します。エラーが発生している。」の検出を検証
  - 既存の検出パターンが壊れていないことを確認

### ら抜き言葉ルールの改善

- [x] 32. ら抜き言葉ルールの検出精度向上
  - `RaNukiRule`を改善（`server/src/grammar/rules/raNukiRule.ts`）
  - 2トークンに分割されたら抜き言葉を検出
  - 検出漏れ例: `食べれる`、`起きれる`、`考えれる`（「食べ」+「れる」に分割される問題に対応）
  - `checkTwoTokenRaNuki`メソッドを追加
  - 一段活用動詞+「れる」のパターンを検出
  - 既存のテストを更新
  - 新しいテストケースを追加

- [x] 32.1 プロパティテスト: ら抜き言葉ルールの改善
  - **プロパティ 3: ら抜き言葉の検出と提案**（更新）
  - より多くの一段活用動詞を検証
  - **検証: 要件 2.1, 2.2, 2.3, 2.4, 2.5**

- [x] 32.2 ユニットテスト: ら抜き言葉ルールの改善
  - 「食べれる」→「食べられる」の検出を検証
  - 「起きれる」→「起きられる」の検出を検証
  - 「考えれる」→「考えられる」の検出を検証
  - 既存の検出パターンが壊れていないことを確認

### Evalsテストの更新

- [x] 33. Evalsテストの再実行と検証
  - 改善後のルールでEvalsを再実行
  - 検出率の向上を確認
  - 目標達成: 助詞連続 100%、冗長な助動詞 100%、文体混在 100%、ら抜き言葉 100%
  - `evals-report.md`を更新
  - 実装済み全15カテゴリで100%の検出率を達成

- [x] 33.1 統合テスト: 改善後の全体検証
  - すべての改善されたルールが正しく動作することを検証
  - 既存の機能が壊れていないことを確認（リグレッションテスト）
  - パフォーマンスが劣化していないことを確認

- [x] 34. 最終チェックポイント - 改善後のテスト確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する
  - Evalsの検出率が目標値に達していることを確認
  - 実装済み全カテゴリで100%の検出率を達成
