# 実装計画

## 既存の実装について

既存のシステムには以下が実装済みです：
- `GrammarChecker`クラス（`server/src/grammar/checker.ts`）
- `AdvancedRulesManager`クラス（`server/src/grammar/advancedRulesManager.ts`）
- `AdvancedGrammarRule`インターフェース
- 15種類の高度な文法ルール
- `Token`、`GrammarError`、`Diagnostic`などのコア型定義（`shared/src/types.ts`）
- `Sentence`、`AdvancedDiagnostic`などの高度なデータモデル

新しい追加文法ルールは、既存の`AdvancedGrammarRule`インターフェースを実装する形で追加します。

## タスク

- [x] 1. 追加文法ルール用の型定義の追加
  - `GrammarErrorType`に新しいエラータイプを追加（`shared/src/types.ts`）
  - RedundantExpression、Tautology等の新しいデータモデルを追加
  - 追加ルール用の設定型を定義
  - _要件: 1.1, 2.1, 3.1, 4.1, 5.1, 6.1_

- [x] 2. Redundant Expression Ruleの実装
  - `RedundantExpressionRule`クラスを作成（`server/src/grammar/rules/redundantExpressionRule.ts`）
  - `AdvancedGrammarRule`インターフェースを実装
  - 冗長表現パターンを定義（「馬から落馬」「後で後悔」「一番最初」など）
  - 文字列パターンマッチングによる検出を実装
  - 簡潔な表現への修正提案を生成
  - 診断情報を生成
  - 既存の`AdvancedRulesManager`に登録
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 2.1 プロパティテスト: 冗長表現の検出と提案
  - **プロパティ 1: 冗長表現の検出と提案**
  - **検証: 要件 1.1, 1.2, 1.3, 1.4, 1.5**

- [x] 2.2 ユニットテスト: Redundant Expression Rule
  - 「馬から落馬する」→「落馬する」の検出を検証
  - 「後で後悔する」→「後悔する」の検出を検証
  - 「一番最初」→「最初」の検出を検証
  - 「各々それぞれ」→「それぞれ」の検出を検証
  - 正しい表現でエラーが出ないことを検証
  - _要件: 1.1, 1.2, 1.3_

- [x] 3. Tautology Ruleの実装
  - `TautologyRule`クラスを作成（`server/src/grammar/rules/tautologyRule.ts`）
  - `AdvancedGrammarRule`インターフェースを実装
  - 重複表現パターンを定義（「頭痛が痛い」「違和感を感じる」「被害を被る」など）
  - 文字列パターンマッチングによる検出を実装
  - 適切な表現への修正提案を生成（複数候補）
  - 診断情報を生成
  - 既存の`AdvancedRulesManager`に登録
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 3.1 プロパティテスト: 重複表現（同語反復）の検出と提案
  - **プロパティ 2: 重複表現（同語反復）の検出と提案**
  - **検証: 要件 2.1, 2.2, 2.3, 2.4, 2.5**

- [x] 3.2 ユニットテスト: Tautology Rule
  - 「頭痛が痛い」→「頭が痛い / 頭痛がする」の検出を検証
  - 「違和感を感じる」→「違和感がある」の検出を検証
  - 「被害を被る」→「被害を受ける」の検出を検証
  - 「犯罪を犯す」→「罪を犯す」の検出を検証
  - 正しい表現でエラーが出ないことを検証
  - _要件: 2.1, 2.2, 2.3_

- [x] 4. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [x] 5. No Particle Chain Ruleの実装
  - `NoParticleChainRule`クラスを作成（`server/src/grammar/rules/noParticleChainRule.ts`）
  - `AdvancedGrammarRule`インターフェースを実装
  - トークンリストから助詞「の」の連続を検出
  - 閾値（デフォルト3回）以上の連続を検出
  - 文の書き換え提案を生成
  - 診断情報に連続回数を含める
  - 設定による閾値の制御を実装
  - 既存の`AdvancedRulesManager`に登録
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [x] 5.1 プロパティテスト: 助詞「の」連続使用の閾値チェック
  - **プロパティ 3: 助詞「の」連続使用の閾値チェック**
  - **検証: 要件 3.1, 3.2, 3.3, 3.4**

- [x] 5.2 ユニットテスト: No Particle Chain Rule
  - 「東京の会社の部長の息子」（4回連続）の検出を検証
  - 「彼の家の庭」（2回連続）で検出されないことを検証
  - 閾値設定による動作変更を検証
  - 診断情報に連続回数が含まれることを検証
  - _要件: 3.1, 3.3, 3.4_

- [x] 6. Monotonous Ending Ruleの実装
  - `MonotonousEndingRule`クラスを作成（`server/src/grammar/rules/monotonousEndingRule.ts`）
  - `AdvancedGrammarRule`インターフェースを実装
  - 文のリストから文末表現を抽出
  - 同じ文末表現の連続回数をカウント
  - 閾値（デフォルト3回）以上の連続を検出
  - 文末表現のバリエーション提案を生成
  - 診断情報に連続回数を含める
  - 設定による閾値の制御を実装
  - 既存の`AdvancedRulesManager`に登録
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 6.1 プロパティテスト: 文末表現の単調さ検出
  - **プロパティ 4: 文末表現の単調さ検出**
  - **検証: 要件 4.1, 4.2, 4.3, 4.4, 4.5**

- [x] 6.2 ユニットテスト: Monotonous Ending Rule
  - 「です。です。です。」（3回連続）の検出を検証
  - 「ます。ます。ます。」（3回連続）の検出を検証
  - 「です。ます。です。」（異なる文末）で検出されないことを検証
  - 閾値設定による動作変更を検証
  - バリエーション提案の生成を検証
  - _要件: 4.1, 4.3, 4.4_

- [x] 7. Long Sentence Ruleの実装
  - `LongSentenceRule`クラスを作成（`server/src/grammar/rules/longSentenceRule.ts`）
  - `AdvancedGrammarRule`インターフェースを実装
  - 文の文字数をカウント
  - 閾値（デフォルト120文字）を超える文を検出
  - 文の分割提案を生成（接続詞や読点での分割候補）
  - 診断情報に文字数を含める
  - 設定による閾値の制御を実装
  - 既存の`AdvancedRulesManager`に登録
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [x] 7.1 プロパティテスト: 長文の文字数チェック
  - **プロパティ 5: 長文の文字数チェック**
  - **検証: 要件 5.1, 5.2, 5.3, 5.4**

- [x] 7.2 ユニットテスト: Long Sentence Rule
  - 120文字超過の文の検出を検証
  - 120文字以下で検出されないことを検証
  - 閾値設定による動作変更を検証
  - 診断情報に文字数が含まれることを検証
  - 分割提案の生成を検証
  - _要件: 5.1, 5.3, 5.4_

- [x] 8. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [x] 9. Additional Rules Configの実装
  - 設定インターフェースを定義（`shared/src/types.ts`に追加）
  - デフォルト設定値を定義
  - 各追加ルールの有効/無効設定を実装
  - 「の」連続の閾値設定を実装
  - 文末単調さの閾値設定を実装
  - 長文の文字数閾値設定を実装
  - 設定の読み書き機能を実装
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 9.1 プロパティテスト: 設定変更の即時反映
  - **プロパティ 6: 設定変更の即時反映**
  - **検証: 要件 6.5**

- [x] 9.2 ユニットテスト: Additional Rules Config
  - デフォルト設定値を検証
  - 各ルールの有効/無効設定を検証
  - 閾値設定の読み書きを検証
  - 設定範囲外の値の処理を検証
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [x] 10. 既存Advanced Rules Managerとの統合
  - 追加ルールを既存のAdvanced Rules Managerに統合
  - 基本ルール、高度なルール、追加ルールの診断情報をマージ
  - 設定による追加ルールの有効/無効を実装
  - パフォーマンスの最適化（並列実行など）
  - _要件: 1.1, 2.1, 3.1, 4.1, 5.1_

- [x] 10.1 統合テスト: Advanced Rules Managerとの統合
  - 基本ルール、高度なルール、追加ルールが全て実行されることを検証
  - 診断情報のマージを検証
  - 設定による制御を検証
  - パフォーマンスが劣化していないことを確認
  - _要件: 6.5_

- [x] 11. VSCode設定項目の追加
  - package.jsonに追加文法ルールの設定項目を追加
  - 各追加ルールの有効/無効設定を追加
  - 「の」連続の閾値設定を追加
  - 文末単調さの閾値設定を追加
  - 長文の文字数閾値設定を追加
  - 設定の説明とデフォルト値を記述
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [x] 12. Evalsテストスイートの更新
  - `ng-examples-data.ts`の追加ルール部分のステータスを`IMPLEMENTED`に更新
  - 新しいルールの期待されるルールコードを設定
  - Evalsテストを実行して検出率を確認
  - `evals-report.md`を更新
  - 目標: 追加5カテゴリで100%の検出率を達成
  - _要件: 1.1, 2.1, 3.1, 4.1, 5.1_

- [x] 12.1 統合テスト: Evalsテストの検証
  - 冗長表現カテゴリの検出を検証
  - 重複表現カテゴリの検出を検証
  - 助詞「の」連続カテゴリの検出を検証
  - 文末単調さカテゴリの検出を検証
  - 長文カテゴリの検出を検証

- [x] 13. READMEの更新
  - 追加文法ルールの機能説明を追加
  - 各ルールの説明と例を記述
  - 設定項目の説明を追加
  - 使用例とスクリーンショットを追加
  - 検出カバレッジ率の更新
  - _要件: 1.1, 2.1, 3.1, 4.1, 5.1, 6.1_

- [x] 14. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する
  - Evalsの検出率が目標値に達していることを確認
  - 追加5カテゴリで100%の検出率を達成
