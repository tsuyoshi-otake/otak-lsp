# 要件定義書

## はじめに

文法チェック機能の品質評価システム（Evals）に新しいNGパターンを追加し、検出カバレッジを拡充します。現在44カテゴリのNGパターンが定義されていますが、実際の日本語文書で発生する文法エラーはさらに多様です。

特に「混在」に関連するNGパターン（表記の不統一、スタイルの混在、記号の混在など）は、技術文書やビジネス文書で頻繁に発生します。また、Markdown記法内での日本語の取り扱いに関する問題も多く見られます。

この機能では、以下のような新しいNGパターンカテゴリを追加し、それらを検出するルールを実装します：

**混在系NGパターン:**
- 敬語と常体の混在（既存の文体混在とは異なる細かいケース）
- 句読点スタイルの混在（、。と，．の混在）
- 引用符スタイルの混在（「」と""と''の混在）
- 箇条書き記号の混在（・と-と*の混在）
- 単位表記の混在（km/h と キロメートル毎時 の混在）
- 人称代名詞の混在（私/僕/自分/当方の混在）
- 時制の混在（過去形と現在形の不自然な混在）
- 英語表記の混在（大文字小文字の不統一、例：api/API/Api）

**Markdown記法関連NGパターン:**
- 見出しレベルの飛び（h1の次にh3など）
- リンクテキストと実際のURLの不一致
- 画像の代替テキスト欠落
- コードブロックの言語指定欠落
- テーブルの列数不一致
- 強調記号の不統一（**太字**と__太字__の混在）
- リスト記号の不統一（-と*の混在）
- 空行の不統一（見出し前後の空行ルール違反）

## 用語集

- **Evals**: 文法チェック機能の品質評価システム。NGパターンの検出率を測定する
- **NGパターン**: 文法的に誤っている、または推奨されない日本語表現
- **カテゴリ**: NGパターンの分類単位。各カテゴリには複数の例文が含まれる
- **検出率**: カテゴリ内の例文のうち、文法チェックで正しく検出できた割合
- **ルール**: 特定のNGパターンを検出するための文法チェックロジック

## 要件

### 要件 1

**ユーザーストーリー:** 開発者として、Evalsに新しいNGパターンカテゴリを追加したい。そうすることで、文法チェック機能のカバレッジを拡大できる。

#### 受入基準

1. WHEN 開発者が新しいNGパターンカテゴリを定義するとき THEN システムは `ng-examples-data.ts` にカテゴリ情報を追加する
2. WHEN カテゴリに複数の例文を追加するとき THEN システムは各例文に対してテキスト、正しい例文、説明を含める
3. WHEN カテゴリのステータスを設定するとき THEN システムは `IMPLEMENTED` または `NOT_IMPL` のいずれかを指定する
4. WHEN カテゴリに期待されるルールコードを設定するとき THEN システムはルール実装時に使用するコードを指定する

### 要件 2

**ユーザーストーリー:** 開発者として、追加したNGパターンを検出するルールを実装したい。そうすることで、実際の文法チェックで新しいパターンを検出できる。

#### 受入基準

1. WHEN 新しいルールを実装するとき THEN システムは `server/src/grammar/rules/` にルールファイルを作成する
2. WHEN ルールが形態素解析結果を処理するとき THEN システムは `Token[]` と `RuleContext` を受け取る
3. WHEN ルールがNGパターンを検出するとき THEN システムは `AdvancedDiagnostic` を返す
4. WHEN ルールを登録するとき THEN システムは `AdvancedRulesManager` にルールを追加する

### 要件 3

**ユーザーストーリー:** 開発者として、追加したNGパターンの検出率を測定したい。そうすることで、ルール実装の品質を確認できる。

#### 受入基準

1. WHEN Evalsを実行するとき THEN システムは新しいカテゴリの例文を評価する
2. WHEN カテゴリの検出率を計算するとき THEN システムは検出数を例文数で割った値を返す
3. WHEN Evalsレポートを生成するとき THEN システムは新しいカテゴリの結果を含める
4. WHEN READMEを更新するとき THEN システムは新しいカテゴリの検出状況を表示する

### 要件 4

**ユーザーストーリー:** ユーザーとして、新しいNGパターンが実際の文書で検出されることを期待する。そうすることで、文書の品質を向上できる。

#### 受入基準

1. WHEN ユーザーが新しいNGパターンを含む文書を開くとき THEN システムは診断情報を表示する
2. WHEN 診断情報が表示されるとき THEN システムはNGパターンの説明と修正案を含める
3. WHEN ルールの設定を変更するとき THEN システムは `package.json` の設定項目を追加する
4. WHEN ルールを無効化するとき THEN システムは該当するNGパターンを検出しない

### 要件 5

**ユーザーストーリー:** ユーザーとして、句読点や引用符のスタイルが統一されていることを確認したい。そうすることで、文書の一貫性を保てる。

#### 受入基準

1. WHEN 文書内で句読点「、。」と「，．」が混在するとき THEN システムは混在を検出する
2. WHEN 文書内で引用符「「」」と「""」が混在するとき THEN システムは混在を検出する
3. WHEN 箇条書きで記号「・」と「-」と「*」が混在するとき THEN システムは混在を検出する
4. WHEN 強調記号「**」と「__」が混在するとき THEN システムは混在を検出する

### 要件 6

**ユーザーストーリー:** ユーザーとして、Markdown記法の構造的な問題を検出したい。そうすることで、正しくレンダリングされる文書を作成できる。

#### 受入基準

1. WHEN 見出しレベルが飛んでいるとき（h1の次にh3など） THEN システムは警告を表示する
2. WHEN テーブルの列数が行ごとに異なるとき THEN システムはエラーを検出する
3. WHEN コードブロックに言語指定がないとき THEN システムは推奨事項を表示する
4. WHEN 画像に代替テキストがないとき THEN システムはアクセシビリティ警告を表示する

### 要件 7

**ユーザーストーリー:** ユーザーとして、英語表記や単位表記の統一性を確認したい。そうすることで、専門的な文書の品質を保てる。

#### 受入基準

1. WHEN 同じ英単語が異なる大文字小文字で表記されるとき（api/API/Api） THEN システムは不統一を検出する
2. WHEN 単位表記が混在するとき（km/h と キロメートル毎時） THEN システムは統一を推奨する
3. WHEN 人称代名詞が混在するとき（私/僕/自分/当方） THEN システムは統一を推奨する
4. WHEN 時制が不自然に混在するとき THEN システムは文脈の確認を促す
