/**
 * Evals Reporter
 * Feature: advanced-grammar-rules
 * Task: 25. Evalsレポート生成機能
 *
 * Markdown形式の評価レポートを生成する
 */

import { EvalResult, CategoryEvalResult, ExampleEvalResult, EvalStatus } from './evals-runner';

/**
 * 検出失敗例の詳細
 */
export interface FailedExample {
  categoryId: string;
  categoryName: string;
  text: string;
  expectedRule: string;
}

/**
 * Evalsレポート生成クラス
 */
export class EvalsReporter {
  /**
   * Markdown形式のフルレポートを生成
   */
  static generateMarkdownReport(result: EvalResult): string {
    const lines: string[] = [];

    // ヘッダー
    lines.push('# Japanese Grammar Evals Report');
    lines.push('');
    lines.push(`Generated: ${this.formatDate(result.timestamp)}`);
    lines.push('');

    // サマリー
    lines.push('## Summary');
    lines.push('');
    lines.push('| Metric | Value |');
    lines.push('|--------|-------|');
    lines.push(`| Total Categories | ${result.totalCategories} |`);
    lines.push(`| Implemented Categories | ${result.implementedCategories} (${Math.round(result.implementedCategories / result.totalCategories * 100)}%) |`);
    lines.push(`| Total Examples | ${result.totalExamples} |`);
    lines.push(`| Detected Examples | ${result.detectedExamples} |`);
    lines.push(`| Detection Rate | ${result.detectionRate}% |`);
    lines.push('');

    // カテゴリ別結果
    lines.push('## Category Results');
    lines.push('');
    lines.push('| Category | Status | Detected | Total | Rate |');
    lines.push('|----------|--------|----------|-------|------|');

    for (const cat of result.categories) {
      const statusIndicator = this.getStatusIndicator(cat.status);
      lines.push(`| ${cat.categoryName} | ${statusIndicator} | ${cat.detected} | ${cat.total} | ${cat.detectionRate}% |`);
    }
    lines.push('');

    // 実装済みカテゴリの詳細
    lines.push('## Implemented Categories');
    lines.push('');
    const implementedCategories = result.categories.filter(c => c.status !== 'NOT_IMPL');
    for (const cat of implementedCategories) {
      lines.push(`### ${cat.categoryName} (${cat.categoryId})`);
      lines.push('');
      lines.push(`- Status: ${this.getStatusIndicator(cat.status)}`);
      lines.push(`- Detection Rate: ${cat.detectionRate}% (${cat.detected}/${cat.total})`);
      lines.push('');

      // 検出失敗例
      const failedExamples = cat.examples.filter(e => !e.detected);
      if (failedExamples.length > 0) {
        lines.push('**Failed Examples:**');
        lines.push('');
        for (const ex of failedExamples) {
          lines.push(`- \`${ex.text}\``);
        }
        lines.push('');
      }
    }

    // 未実装カテゴリ
    lines.push('## Not Implemented Categories');
    lines.push('');
    const notImplementedCategories = result.categories.filter(c => c.status === 'NOT_IMPL');
    for (const cat of notImplementedCategories) {
      lines.push(`- **${cat.categoryName}** (${cat.categoryId}): ${cat.total} examples`);
    }
    lines.push('');

    // フッター
    lines.push('---');
    lines.push('');
    lines.push('*This report was generated by the Japanese Grammar Analyzer Evals system.*');

    return lines.join('\n');
  }

  /**
   * コンソール出力用のサマリーを生成
   */
  static generateConsoleSummary(result: EvalResult): string {
    const lines: string[] = [];

    lines.push('');
    lines.push('=== Japanese Grammar Evals Report ===');
    lines.push('');
    lines.push(`Total Categories: ${result.totalCategories}`);
    lines.push(`Implemented: ${result.implementedCategories} (${Math.round(result.implementedCategories / result.totalCategories * 100)}%)`);
    lines.push(`Detected: ${result.detectedExamples}/${result.totalExamples} examples (${result.detectionRate}%)`);
    lines.push('');

    // ステータス別カウント
    const passCount = result.categories.filter(c => c.status === 'PASS').length;
    const failCount = result.categories.filter(c => c.status === 'FAIL').length;
    const notImplCount = result.categories.filter(c => c.status === 'NOT_IMPL').length;

    lines.push('Category Status:');
    lines.push(`  PASS:     ${passCount}`);
    lines.push(`  FAIL:     ${failCount}`);
    lines.push(`  NOT_IMPL: ${notImplCount}`);
    lines.push('');

    // 検出失敗があるカテゴリ
    const failedCategories = result.categories.filter(c => c.status === 'FAIL');
    if (failedCategories.length > 0) {
      lines.push('Failed Categories (partial detection):');
      for (const cat of failedCategories) {
        lines.push(`  - ${cat.categoryName}: ${cat.detected}/${cat.total} (${cat.detectionRate}%)`);
      }
      lines.push('');
    }

    lines.push(`Generated: ${this.formatDate(result.timestamp)}`);
    lines.push('');

    return lines.join('\n');
  }

  /**
   * README.md埋め込み用のセクションを生成
   */
  static generateReadmeSection(result: EvalResult): string {
    const lines: string[] = [];

    lines.push('## Detection Coverage');
    lines.push('');

    // バッジ
    const badgeColor = this.getBadgeColor(result.detectionRate);
    lines.push(`![Coverage](https://img.shields.io/badge/coverage-${result.detectionRate}%25-${badgeColor})`);
    lines.push('');

    // カテゴリテーブル
    lines.push('| Category | Status | Example |');
    lines.push('|----------|--------|---------|');

    for (const cat of result.categories) {
      const status = this.getStatusIndicator(cat.status);
      const example = this.escapeMarkdown(cat.representativeExample);
      lines.push(`| ${cat.categoryName} | ${status} | ${example} |`);
    }
    lines.push('');

    // フッター
    lines.push(`Last updated: ${this.formatDate(result.timestamp)}`);
    lines.push('');

    return lines.join('\n');
  }

  /**
   * 検出失敗した例文のリストを取得
   */
  static getFailedExamples(result: EvalResult): FailedExample[] {
    const failed: FailedExample[] = [];

    for (const cat of result.categories) {
      if (cat.status === 'NOT_IMPL') continue;

      for (const ex of cat.examples) {
        if (!ex.detected) {
          failed.push({
            categoryId: cat.categoryId,
            categoryName: cat.categoryName,
            text: ex.text,
            expectedRule: ex.expectedRule
          });
        }
      }
    }

    return failed;
  }

  /**
   * ステータスインジケータを取得
   */
  private static getStatusIndicator(status: EvalStatus): string {
    switch (status) {
      case 'PASS':
        return 'PASS';
      case 'FAIL':
        return 'FAIL';
      case 'NOT_IMPL':
        return 'NOT_IMPL';
      default:
        return 'UNKNOWN';
    }
  }

  /**
   * バッジの色を取得
   */
  private static getBadgeColor(rate: number): string {
    if (rate >= 90) return 'brightgreen';
    if (rate >= 70) return 'green';
    if (rate >= 50) return 'yellow';
    if (rate >= 30) return 'orange';
    return 'red';
  }

  /**
   * 日付をフォーマット
   */
  private static formatDate(timestamp: string): string {
    const date = new Date(timestamp);
    return date.toISOString().split('T')[0];
  }

  /**
   * Markdownエスケープ
   */
  private static escapeMarkdown(text: string): string {
    // テーブル内で問題になる文字をエスケープ
    return text
      .replace(/\|/g, '\\|')
      .replace(/\n/g, ' ')
      .substring(0, 50); // 長すぎる場合は切り詰め
  }
}
